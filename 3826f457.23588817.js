(window.webpackJsonp=window.webpackJsonp||[]).push([[14],{151:function(e,n,t){"use strict";t.r(n),t.d(n,"frontMatter",(function(){return r})),t.d(n,"metadata",(function(){return c})),t.d(n,"rightToc",(function(){return l})),t.d(n,"default",(function(){return b}));var i=t(2),o=t(9),a=(t(0),t(172)),r={id:"setup",title:"Service setup guide",sidebar_label:"Setup guide"},c={id:"service/setup",isDocsHomePage:!1,title:"Service setup guide",description:"Fork the repo on Github to get started.",source:"@site/docs/service/setup.md",permalink:"/docs/service/setup",editUrl:"https://github.com/facebook/docusaurus/edit/master/website/docs/service/setup.md",sidebar_label:"Setup guide",sidebar:"docs",previous:{title:"Overview",permalink:"/docs/"},next:{title:"Service admin",permalink:"/docs/service/admin"}},l=[{value:"Create firebase project",id:"create-firebase-project",children:[{value:"Install dependencies",id:"install-dependencies",children:[]}]},{value:"Deploying to App Engine",id:"deploying-to-app-engine",children:[{value:"Secure the endpoints",id:"secure-the-endpoints",children:[]}]},{value:"Setup the firebase environment",id:"setup-the-firebase-environment",children:[]},{value:"Configure Angular Environment variables",id:"configure-angular-environment-variables",children:[]},{value:"Deploying to firebase",id:"deploying-to-firebase",children:[{value:"Production environment",id:"production-environment",children:[]},{value:"Development environment (optional)",id:"development-environment-optional",children:[]}]},{value:"Bootstrap the service",id:"bootstrap-the-service",children:[]},{value:"CI/CD",id:"cicd",children:[{value:"Firebase",id:"firebase",children:[]},{value:"App Engine (development)",id:"app-engine-development",children:[]},{value:"App Engine (production)",id:"app-engine-production",children:[]}]}],p={rightToc:l};function b(e){var n=e.components,t=Object(o.a)(e,["components"]);return Object(a.b)("wrapper",Object(i.a)({},p,t,{components:n,mdxType:"MDXLayout"}),Object(a.b)("p",null,"Fork the repo on ",Object(a.b)("a",Object(i.a)({parentName:"p"},{href:"https://github.com/turtlecoin/trtl-apps"}),"Github")," to get started."),Object(a.b)("h2",{id:"create-firebase-project"},"Create firebase project"),Object(a.b)("p",null,"Go to the ",Object(a.b)("a",Object(i.a)({parentName:"p"},{href:"https://console.firebase.google.com"}),"Firebase console")," and create a new project."),Object(a.b)("p",null,"Upgrade your firebase to the ",Object(a.b)("inlineCode",{parentName:"p"},"blaze")," plan, needed for making outbound function calls."),Object(a.b)("p",null,"Enable the following firebase modules:"),Object(a.b)("ul",null,Object(a.b)("li",{parentName:"ul"},"Authentication with email/password sign-in method"),Object(a.b)("li",{parentName:"ul"},"Create a firestore database and select a region"),Object(a.b)("li",{parentName:"ul"},"Enable Storage"),Object(a.b)("li",{parentName:"ul"},"Enable Functions"),Object(a.b)("li",{parentName:"ul"},"Enable Hosting")),Object(a.b)("h4",{id:"development-project-optional"},"development project (optional)"),Object(a.b)("p",null,"Repeat the steps above to create a firebase project for a development environment."),Object(a.b)("h3",{id:"install-dependencies"},"Install dependencies"),Object(a.b)("p",null,"Open a terminal and navigate to the root directory of your project."),Object(a.b)("p",null,"Run ",Object(a.b)("inlineCode",{parentName:"p"},"npm install")," in the ",Object(a.b)("em",{parentName:"p"},"root")," directory."),Object(a.b)("p",null,"Run ",Object(a.b)("inlineCode",{parentName:"p"},"npm install")," in the ",Object(a.b)("em",{parentName:"p"},"/functions")," directory."),Object(a.b)("p",null,"Run ",Object(a.b)("inlineCode",{parentName:"p"},"npm install")," in the ",Object(a.b)("em",{parentName:"p"},"/app_engine")," directory."),Object(a.b)("h2",{id:"deploying-to-app-engine"},"Deploying to App Engine"),Object(a.b)("p",null,"Run the commands below in the ",Object(a.b)("inlineCode",{parentName:"p"},"app_engine")," directory."),Object(a.b)("p",null,"Perform the build step:"),Object(a.b)("p",null,"  ",Object(a.b)("inlineCode",{parentName:"p"},"npm run build")),Object(a.b)("p",null,"gcloud configurations:"),Object(a.b)("p",null,"  run the following command to create a configuration"),Object(a.b)("p",null,"  ",Object(a.b)("inlineCode",{parentName:"p"},"gcloud init")),Object(a.b)("p",null,"  or select an existing configuration using"),Object(a.b)("p",null,"  ",Object(a.b)("inlineCode",{parentName:"p"},"gcloud config configurations activate my-config")),Object(a.b)("p",null,"  list existing configurations using"),Object(a.b)("p",null,"  ",Object(a.b)("inlineCode",{parentName:"p"},"gcloud config configurations list")),Object(a.b)("p",null,"  visit ",Object(a.b)("a",Object(i.a)({parentName:"p"},{href:"https://cloud.google.com/sdk/gcloud/reference/config/configurations"}),"for more information on configurations"),"."),Object(a.b)("p",null,"Deploy your app for a specific environment:"),Object(a.b)("p",null,"  ",Object(a.b)("inlineCode",{parentName:"p"},"gcloud app deploy app-production.yaml")),Object(a.b)("p",null,"  ",Object(a.b)("inlineCode",{parentName:"p"},"gcloud app deploy app-development.yaml")," (optional)"),Object(a.b)("h3",{id:"secure-the-endpoints"},"Secure the endpoints"),Object(a.b)("p",null,"In the GCP menu, navigate to ",Object(a.b)("inlineCode",{parentName:"p"},"Security -> Identity-Aware Proxy"),". Turn on the ",Object(a.b)("inlineCode",{parentName:"p"},"IAP")," toggle for the App Engine resource.\nSelect the app engine resource and click ",Object(a.b)("inlineCode",{parentName:"p"},"ADD MEMBER")," on the right-hand menu and add the firebase default service account email address(can be found in the firebase console ",Object(a.b)("inlineCode",{parentName:"p"},"Settings -> Service accounts"),"). Give the new member the ",Object(a.b)("inlineCode",{parentName:"p"},"IAP-secured Web App User")," role. Members added here will have access to call the app engine API enpoints."),Object(a.b)("h2",{id:"setup-the-firebase-environment"},"Setup the firebase environment"),Object(a.b)("p",null,"Download the firebase project service account key file in the firebase console: ",Object(a.b)("inlineCode",{parentName:"p"},"Settings -> Project settings -> Service Accounts")," and select ",Object(a.b)("inlineCode",{parentName:"p"},"Generate new private key"),". Rename the file to ",Object(a.b)("inlineCode",{parentName:"p"},"gcp_account_key.json"),". Upload this json file to the project's storage bucket in the root directory."),Object(a.b)("p",null,"Run the following commands in the project root directory."),Object(a.b)("p",null,"Sign in to firebase using the CLI: ",Object(a.b)("inlineCode",{parentName:"p"},"firebase login")),Object(a.b)("p",null,"Set your service master password in the environment variables: ",Object(a.b)("inlineCode",{parentName:"p"},'firebase functions:config:set serviceadmin.password="YOUR ADMIN PASSWORD"'),"\nPick a strong password and keep it safely backed up, this is the password used to encrypt the service wallet file."),Object(a.b)("p",null,"In the project's GCP console, click ",Object(a.b)("inlineCode",{parentName:"p"},"Security -> Identity-Aware Proxy"),". In the context menu select ",Object(a.b)("inlineCode",{parentName:"p"},"Edit OAuth client"),". Copy the ",Object(a.b)("inlineCode",{parentName:"p"},"Client ID")," field for use in the next step."),Object(a.b)("p",null,"Set the following values in the environment variables:"),Object(a.b)("p",null,Object(a.b)("inlineCode",{parentName:"p"},'firebase functions:config:set appengine.target_audience="YOUR CLIENT ID"')),Object(a.b)("p",null,"Set SendGrid API key for admin emails (optional)"),Object(a.b)("p",null,Object(a.b)("inlineCode",{parentName:"p"},'firebase functions:config:set sendgrid.apikey="YOUR SENDGRID API KEY"')),Object(a.b)("h2",{id:"configure-angular-environment-variables"},"Configure Angular Environment variables"),Object(a.b)("p",null,"Set the ",Object(a.b)("inlineCode",{parentName:"p"},"environment.ts")," and ",Object(a.b)("inlineCode",{parentName:"p"},"environment.prod.ts")," variables for your project's development and production environments. The Firebase config information can be found in the firebase ",Object(a.b)("inlineCode",{parentName:"p"},"console -> project settings -> firebase SDK snippet -> config"),"."),Object(a.b)("h2",{id:"deploying-to-firebase"},"Deploying to firebase"),Object(a.b)("h3",{id:"production-environment"},"Production environment"),Object(a.b)("p",null,"Build the angular project using ",Object(a.b)("inlineCode",{parentName:"p"},"ng build --prod")),Object(a.b)("p",null,"Run ",Object(a.b)("inlineCode",{parentName:"p"},"firebase use production")," to switch to the production firebase project."),Object(a.b)("p",null,"Run ",Object(a.b)("inlineCode",{parentName:"p"},"firebase deploy")," to deploy the project."),Object(a.b)("p",null,"For a single command, you can also use the -P flag: ",Object(a.b)("inlineCode",{parentName:"p"},"firebase deploy -P production"),"."),Object(a.b)("h3",{id:"development-environment-optional"},"Development environment (optional)"),Object(a.b)("p",null,"Build the angular project using ",Object(a.b)("inlineCode",{parentName:"p"},"ng build")),Object(a.b)("p",null,"Run the angular front-end locally using ",Object(a.b)("inlineCode",{parentName:"p"},"ng serve")),Object(a.b)("p",null,"Run ",Object(a.b)("inlineCode",{parentName:"p"},"firebase use development")," to switch to the development firebase project."),Object(a.b)("p",null,"Run ",Object(a.b)("inlineCode",{parentName:"p"},"firebase deploy")," to deploy the project."),Object(a.b)("p",null,"For a single command, you can also use the -P flag: ",Object(a.b)("inlineCode",{parentName:"p"},"firebase deploy -P development"),"."),Object(a.b)("h2",{id:"bootstrap-the-service"},"Bootstrap the service"),Object(a.b)("p",null,"In the firebase console, navigate to the Authentication section and enable the email/password sign-in method. Create a new user account with your email address, we will give this user service admin rights in a later step."),Object(a.b)("p",null,"Open ",Object(a.b)("em",{parentName:"p"},"functions")," tab, copy the URL of the ",Object(a.b)("inlineCode",{parentName:"p"},"serviceAdmin-bootstrap")," function."),Object(a.b)("p",null,"Send a GET request to the bootstrap URL passing in the email address of the user you created earlier as an 'admin' query parameter. Example cURL request:"),Object(a.b)("p",null,Object(a.b)("inlineCode",{parentName:"p"},"curl --location --request GET 'BOOTSTRAP_URL?admin=ADMIN_EMAIL_ADDRESS'")),Object(a.b)("p",null,"If the service bootstrapped succesfully, it will send an OK response. see the ",Object(a.b)("a",Object(i.a)({parentName:"p"},{href:"/docs/service/admin"}),"Admin")," section for information on service admin functionality. If you are already signed in to the frontend, you may have to sign out and back in for the auth token to update with the new admin privilages."),Object(a.b)("h2",{id:"cicd"},"CI/CD"),Object(a.b)("p",null,"The project uses Github actions to automatically build and deploy on pushes to the ",Object(a.b)("inlineCode",{parentName:"p"},"master")," and ",Object(a.b)("inlineCode",{parentName:"p"},"development")," and branches. Set the following github secrets in ",Object(a.b)("inlineCode",{parentName:"p"},"settings -> secrets")," needed for the actions to run:"),Object(a.b)("h3",{id:"firebase"},"Firebase"),Object(a.b)("p",null,"key: ",Object(a.b)("inlineCode",{parentName:"p"},"FIREBASE_TOKEN")),Object(a.b)("p",null,"value: ",Object(a.b)("inlineCode",{parentName:"p"},"YOUR_FIREBASE_TOKEN")," (run ",Object(a.b)("inlineCode",{parentName:"p"},"firebase login:ci")," in the project folder to get your token)"),Object(a.b)("h3",{id:"app-engine-development"},"App Engine (development)"),Object(a.b)("p",null,"name: ",Object(a.b)("inlineCode",{parentName:"p"},"GCP_SA_KEY_DEV")),Object(a.b)("p",null,"value: ",Object(a.b)("inlineCode",{parentName:"p"},"ENCODED_SERVICE_ACCOUNT_KEY")," (see instructions below for how to get this key)"),Object(a.b)("p",null,"name: ",Object(a.b)("inlineCode",{parentName:"p"},"GAE_PROJECT_ID_DEV")),Object(a.b)("p",null,"value: ",Object(a.b)("inlineCode",{parentName:"p"},"APP_ENGINE_PROJECT_ID")),Object(a.b)("h3",{id:"app-engine-production"},"App Engine (production)"),Object(a.b)("p",null,"name: ",Object(a.b)("inlineCode",{parentName:"p"},"GCP_SA_KEY_PROD")),Object(a.b)("p",null,"value: ",Object(a.b)("inlineCode",{parentName:"p"},"ENCODED_SERVICE_ACCOUNT_KEY")," (see instructions below for how to get this key)"),Object(a.b)("p",null,"name: ",Object(a.b)("inlineCode",{parentName:"p"},"GAE_PROJECT_ID_PROD")),Object(a.b)("p",null,"value: ",Object(a.b)("inlineCode",{parentName:"p"},"APP_ENGINE_PROJECT_ID")),Object(a.b)("h4",{id:"getting-the-encoded_service_account_key"},"Getting the ENCODED_SERVICE_ACCOUNT_KEY"),Object(a.b)("p",null,"Get the service account key which will be used for authentication. This key should be ",Object(a.b)("a",Object(i.a)({parentName:"p"},{href:"https://cloud.google.com/iam/docs/creating-managing-service-account-keys"}),"created")," using JSON, encoded as a Base64 string (eg. cat my_key.json | base64 on macOS). On windows you can use: ",Object(a.b)("inlineCode",{parentName:"p"},"certutil -encode my_key.json encoded_key.json")," to generate a Base64 encoded file."))}b.isMDXComponent=!0},172:function(e,n,t){"use strict";t.d(n,"a",(function(){return s})),t.d(n,"b",(function(){return m}));var i=t(0),o=t.n(i);function a(e,n,t){return n in e?Object.defineProperty(e,n,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[n]=t,e}function r(e,n){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);n&&(i=i.filter((function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable}))),t.push.apply(t,i)}return t}function c(e){for(var n=1;n<arguments.length;n++){var t=null!=arguments[n]?arguments[n]:{};n%2?r(Object(t),!0).forEach((function(n){a(e,n,t[n])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):r(Object(t)).forEach((function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(t,n))}))}return e}function l(e,n){if(null==e)return{};var t,i,o=function(e,n){if(null==e)return{};var t,i,o={},a=Object.keys(e);for(i=0;i<a.length;i++)t=a[i],n.indexOf(t)>=0||(o[t]=e[t]);return o}(e,n);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);for(i=0;i<a.length;i++)t=a[i],n.indexOf(t)>=0||Object.prototype.propertyIsEnumerable.call(e,t)&&(o[t]=e[t])}return o}var p=o.a.createContext({}),b=function(e){var n=o.a.useContext(p),t=n;return e&&(t="function"==typeof e?e(n):c(c({},n),e)),t},s=function(e){var n=b(e.components);return o.a.createElement(p.Provider,{value:n},e.children)},u={inlineCode:"code",wrapper:function(e){var n=e.children;return o.a.createElement(o.a.Fragment,{},n)}},d=o.a.forwardRef((function(e,n){var t=e.components,i=e.mdxType,a=e.originalType,r=e.parentName,p=l(e,["components","mdxType","originalType","parentName"]),s=b(t),d=i,m=s["".concat(r,".").concat(d)]||s[d]||u[d]||a;return t?o.a.createElement(m,c(c({ref:n},p),{},{components:t})):o.a.createElement(m,c({ref:n},p))}));function m(e,n){var t=arguments,i=n&&n.mdxType;if("string"==typeof e||i){var a=t.length,r=new Array(a);r[0]=d;var c={};for(var l in n)hasOwnProperty.call(n,l)&&(c[l]=n[l]);c.originalType=e,c.mdxType="string"==typeof e?e:i,r[1]=c;for(var p=2;p<a;p++)r[p]=t[p];return o.a.createElement.apply(null,r)}return o.a.createElement.apply(null,t)}d.displayName="MDXCreateElement"}}]);